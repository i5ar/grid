<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="isometric grid generator">
	<title>isometric grid generator</title>
	<link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
</head>

<body onload="updateGrid();">

	<main id="sketch-holder">

		<canvas id="canvas" class="canvas"></canvas>
	</main>

	<aside>
		<div class="draw">
			<input type="button" id="polyline" value="â¹ï¸ polyline" />
			<input type="button" id="polygon" value="ðŸŸ¦ polygon" />
		</div>
		<div class="edit">
			<input type="color" id="fill" value="#ff00ff" style="height: 24px" />
			<input type="button" id="remove" value="âŒ remove" />
		</div>
		<div class="file">
			<input type="button" id="save" value="ðŸ’¾ save">
			<input type="button" id="load" value="â¬†ï¸ load">
		</div>

		<!-- <div id="debug">double click to end polyline or close polygon</div> -->
	</aside>

	<form id="settings">

		<label for="cell-height">cell height<span></span></label>
		<input type="range" id="cell-height" value="64" name="cell-height" min="10" max="200" oninput="updateGrid();" />

		<label for="line-width">line width<span></span></label>
		<input type="range" id="line-width" value="1" name="line-width" min="1" max="20" oninput="updateGrid();" />

		<label for="stroke-style">stroke style<span></span></label>
		<input type="color" id="stroke-style" value="#888888" name="stroke-style" style="height: 24px" oninput="updateGrid();" />

		<!-- <input type="button" value="download" onclick="downloadCell();" /> -->

		<input type="button" value="ðŸ“– print" onclick="printGrid();">

	</form>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.6.0/tinycolor.min.js"
		integrity="sha512-AvCfbOQzCVi2ctVWF4m89jLwTn/zVPJuS7rhiKyY3zqyCdbPqtvNa0I628GJqPytbowfFjkAGOpq85E5kQc40Q=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script>

		const oElement = document.documentElement;
		const oCanvas = document.createElement('canvas');
		const oContext = oCanvas.getContext("2d");

		const gridSettingsElement = document.getElementById('settings');
		const cellHeightElement = gridSettingsElement['cell-height'];
		const lineWidthElement = gridSettingsElement['line-width'];
		const strokeStyleElement = gridSettingsElement['stroke-style'];

		function updateGrid() {
			const cellHeight = parseInt(cellHeightElement.value, 10);
			const cellWidth = cellHeight * Math.sqrt(3);

			const lineWidth = parseInt(lineWidthElement.value, 10);

			const strokeStyle = strokeStyleElement.value;

			gridSettingsElement.querySelector("label[for='cell-height'] span").innerHTML = cellHeight;
			gridSettingsElement.querySelector("label[for='line-width'] span").innerHTML = lineWidth;
			gridSettingsElement.querySelector("label[for='stroke-style'] span").innerHTML = strokeStyle;

			oCanvas.setAttribute('width', cellWidth);
			oCanvas.setAttribute('height', cellHeight);

			oContext.clearRect(0, 0, cellWidth, cellHeight);

			oContext.strokeStyle = strokeStyle;
			oContext.lineWidth = lineWidth;

			oContext.beginPath();
			oContext.moveTo(cellWidth / 2, 0);
			oContext.lineTo(0, cellHeight / 2);
			oContext.lineTo(cellWidth / 2, cellHeight);
			oContext.lineTo(cellWidth, cellHeight / 2);
			oContext.lineTo(cellWidth / 2, 0);
			oContext.lineTo(cellWidth / 2, cellHeight);
			oContext.moveTo(cellWidth, 0);
			oContext.lineTo(cellWidth, cellHeight);
			oContext.moveTo(0, 0);
			oContext.lineTo(0, cellHeight);
			oContext.stroke();

			oElement.style.backgroundImage = 'url("' + oCanvas.toDataURL() + '")';
		}


		// https://stackoverflow.com/questions/58711027/draw-a-straight-line-between-two-points-selected-in-a-mouse-down-event

		// https://codepen.io/Rstewart/pen/ZEBORxN
		var canvas;
		var obj;
		var polyline;
		var mouseDown = false;
		var pts = [];
		var lastPt = 1;
		var polyType = 'Polyline';
		var polyBtn;
		var poly = false;
		var bgColor;
		var sColor;
		var spessore;
		var id = -1;

		// NOTE: Snap to grid using the nearest multiple instead of mouse.y and mouse.x.
		function snapCoord() {
			const cellHeight = parseInt(cellHeightElement.value, 10);
			const cellWidth = cellHeight * Math.sqrt(3);
			const gridModuleX = Math.floor(cellWidth / 2);
			const gridModuleY = cellHeight / 2;
			const nearestMultiple = (n, gridModule) => Math.round(n / gridModule) * gridModule;
			return { x: nearestMultiple(mouse.x, gridModuleX), y: nearestMultiple(mouse.y, gridModuleY) };
		}

		canvas = new fabric.Canvas(document.querySelector("canvas"), {
			objectCaching: false
		});

		canvas.setHeight(window.innerHeight);
		canvas.setWidth(window.innerWidth);

		canvas.on('mouse:down', function (e) {
			if (poly == true) {

				polyline = new fabric[polyType](pts, {
					objectCaching: false,
					name: 'temp',
					fill: '',
					stroke: sColor,
					strokeWidth: 4,
					originX: 'center',
					originY: 'center',
					selectable: false,
				});

				const snap = snapCoord();
				polyline.points[pts.length] = { x: snap.x, y: snap.y };
				canvas.add(polyline);
				lastPt++;
				mouseDown = true;
				// document.querySelector("#debug").textContent = JSON.stringify(pts)

			} else {
				// NOTE: Make all objects selectable while not drawing.
				canvas.getObjects().map(item => item.selectable = true);
			}
		});

		canvas.on('mouse:move', function (e) {
			mouse = canvas.getPointer(e.e);
			if (poly == true && mouseDown) {

				const snap = snapCoord();

				polyline.points[lastPt - 1] = { x: snap.x, y: snap.y };
				canvas.renderAll();
			}
		});

		function createObj(points) {
			canvas.forEachObject(function (obj) {
				if (obj.name === 'temp') canvas.remove(obj);
			});

			polyObj = new fabric[polyType](points, {
				objectCaching: false,
				id: id++,
				fill: bgColor,
				stroke: sColor,
				strokeWidth: spessore,
				originX: 'center',
				originY: 'center',
				selectable: true,
				// Remove controls: http://fabricjs.com/customization
				hasControls: false,
				lockRotation: true,
				lockScalingX: true,
				lockScalingY: true,
				lockMovementX: true,
				lockMovementY: true
			});

			canvas.add(polyObj);
			poly = false;
			polyBtn = '';
			lastPt = 1;
			mouseDown = false;
			pts = [];

			document.querySelector('.draw input').classList.remove('active');
		}

		canvas.on('mouse:dblclick', function (e) {
			createObj(pts);
		});

		document.onkeydown = function (evt) {
			if (evt.key === "Delete") canvas.remove(...canvas.getActiveObjects());
			else if (evt.key === "Escape") createObj(pts.slice(0, -1));
		};

		canvas.on('selection:created', function (e) {
			obj = canvas.getActiveObject();
			obj.hasControls = false;
			obj.lockRotation = true;
			obj.lockScalingX = true;
			obj.lockScalingY = true;
			obj.lockMovementX = true;
			obj.lockMovementY = true;
		});

		canvas.on('selection:cleared', function () {
			obj = '';
		});

		const drawInputs = document.querySelectorAll(".draw input");
		for (let i = 0; i < drawInputs.length; i++) {

			drawInputs[i].addEventListener('click', function (event) {

				for (let i = 0; i < drawInputs.length; i++) drawInputs[i].classList.remove('active');

				this.classList.add('active');
				polyBtn = this.getAttribute("id");

				if (polyBtn == 'polyline') {
					polyType = 'Polyline';
					poly = true;
					bgColor = '';
					sColor = 'black';
					spessore = 4;
				}
				if (polyBtn == 'polygon') {
					polyType = 'Polygon';
					poly = true;
					bgColor = tinycolor(document.querySelector('.edit input#fill').value).setAlpha(.5).toRgbString();
					sColor = document.querySelector('.edit input#fill').value;
					spessore = 0;
				}

				// NOTE: Make all objects not selectable while drawing.
				canvas.getObjects().map(item => item.selectable = false);

			}, false);

		}

		// NOTE: Remove object.
		document.querySelector('.edit input#remove').onclick = () => canvas.remove(...canvas.getActiveObjects());
		// NOTE: Edit fill color.
		document.querySelector('.edit input#fill').oninput = (e) => {
			objs = canvas.getActiveObjects();
			objs.map(obj => obj.get('type') === 'polygon' ? obj.fill = e.target.value : "");
		}
		// NOTE: Save: https://stackoverflow.com/questions/40280110/how-to-add-transparency-to-a-value-from-a-html-input-type-color-field-in-css
		document.querySelector('.file input#save').onclick = () => {
			var json = canvas.toJSON();
			alert(JSON.stringify(json));
			localStorage.setItem("iso-grid", JSON.stringify(json));
		}
		document.querySelector('.file input#load').onclick = () => {
			var json = localStorage.getItem("iso-grid");
			canvas.loadFromJSON(json, function () {
				canvas.renderAll();
			}, function (o, object) {
				console.log(o, object)
			})
		}

		function downloadCell() {
			const link = document.createElement('a');
			link.download = 'isometric.png';
			link.href = oCanvas.toDataURL()
			link.click();
		}

		function printGrid() {
			window.print();
		}

	</script>
</body>

</html>